"""Configuration for MedScanner

@author: Graham Poulter
                                   

Import this module to set up library paths and configure locations to
files used by the scanner, as well as configuration options.

"""

import logging
import sys
import os
from new import module
from path import path

#### Logging configuration

logging.basicConfig(
    level    = logging.DEBUG,
    datefmt  = "%H:%M:%S",
    format   = "%(asctime)-9s %(levelname)-8s %(message)s",
)

#### TOP-LEVEL CONFIGURATION (DO NOT MODIFY FROM OUTSIDE)

## Path to source directory
src = path(sys.argv[0]).dirname().abspath().parent
## Path to top 
top = src.parent
## Path to lib
lib = src / "lib"
sys.path.insert( 0, lib )
## Path to templates
templates = lib / "templates"
## Path to base for working data
working = top / "data"
#working = top / "testing"
## Path to output files
output = working / "output"
## Path to cache directory
cache = working / "cache"
## Path to web output directory
weboutput = src / "www" / "htdocs" / "output"
## Path to corpora
corpora = working / "corpora"
## Path to file with progress statistics
statfile = cache / "mscanner.pid"
## File of e-mail addresses to alert on completion
mailer = cache / "emails.txt"
## Server for sending e-mails
#smtp_server = "smtp.stanford.edu"
smtp_server = "smtp.uct.ac.za"

#### DATABASE CONFIGURATION

## Path to stylesheet for query/validation reports
stylesheet = templates / "style.css"
## Path to BSD DB environment home directory
db_home = cache / "db_home"
## Path to DB of article objects
articledb = cache / "articles.db"
## Path to list of article IDs
articlelist = cache / "articles.txt"
## Path to DB of term features for each article
featuredb = cache / "features.db"
## Path to feature<->ID mapping
featuremap = cache / "featuremap.txt"
## Path to list files already processed
processed = cache / "processed.txt"
## Whether to use transactions while updating
use_transactions = False
## Path to compressed MEDLINE 
medline = working / "medline"
## Number of files to process between saving
save_delay = 5

#### GENEDRUG CONFIGURATION

## Path to GAPScore results in
gapscore = working / "genedrug" / "gapscore.db"
## Path to gene-drug co-occurrence cache
genedrug = working / "genedrug" / "genedrug.db"
## Path to pickled drug table (generated by drugtable.py)
drugtable = working / "genedrug" / "drugtable.txt"

#### QUERY CONFIGURATION (for query.py)

## Positive set
posfile = None
## Integer for maximum number of results (may be fewer due to threshold)
limit = 10000
## Float for minimum score threshold
threshold = 20
## Per-term pseudocount to use
pseudocount = 0.001
## Prefix for result report files
query_report = output / "results"
## Path to database output
outputdb = None
## Types of features to exclude
exclude_feats = None
#exclude_feats = ["mesh","qual","issn"]
#exclude_feats = ["issn"]

#### VALIDATOR CONFIGURATION (for validate.py)

## Positive set
posfile = None
## Negative set
negfile = None
## Validation folds to use
nfolds = 0
## 0<Alpha<1.  Alpha=0.5 maximises standard F-Measure.
fm_tradeoff = 0.5
## Whether to do a gene-drug co-occurrence filter
dogenedrug = False
## Whether to use Daniel's 10^-8 pseudocounts
dodaniel = False
## Prefix to use for report file
valid_report = output / "validation"

#### DATA SET CONFIGURATION

def choose_query(dataset_name):
    global dataset, posfile, query_report
    dataset = dataset_name
    query_report = output / (dataset+"-query")
    if dataset == "pg04":
        posfile = "pharmgkb-2004.txt"
    if dataset == "pg06":
        posfile = "pharmgkb-Oct06.txt"
    if dataset == "aids":
        posfile = "aids-bioethics-Oct06.txt"
    if dataset == "radiology":
        posfile = "daniel-radiology.txt"
    if dataset == "mscanner":
        posfile = "mscanner-bibliography.txt"
    if dataset == "gdsmall":
        posfile = "genedrug-small.txt"
    if not isinstance(posfile, path):
        posfile = corpora / posfile
    
def choose_validation(dataset_name):
    global dataset, posfile, negfile, valid_report
    global exclude_feats, dodaniel
    dataset = dataset_name
    valid_report = output / (dataset+"-valid")
    # Comparing to daniel's old method
    if dataset == "pg04-vs-30k":
        posfile = "pharmgkb-2004.txt"
        negfile = "medline06-30k.txt"
    if dataset == "pg04-vs-30k-dan":
        posfile = "pharmgkb-2004.txt"
        negfile = "medline06-30k.txt"
        exclude_feats = ["issn"]
        dodaniel = True
    if dataset == "pg06-vs-500k-dan":
        posfile = "pharmgkb-Oct06.txt"
        negfile = "medline06-500k.txt"
        exclude_feats = ["issn"]
        dodaniel = True
    if dataset == "pg06-vs-500k-noissn":
        posfile = "pharmgkb-Oct06.txt"
        negfile = "medline06-500k.txt"
        exclude_feats = ["issn"]
    # Primary results
    if dataset == "aids-vs-500k":
        posfile = "aids-bioethics-Oct06.txt"
        negfile = "medline06-500k.txt"
    if dataset == "pg06-vs-500k":
        posfile = "pharmgkb-Oct06.txt"
        negfile = "medline06-500k.txt"
    if dataset == "radiology-vs-500k":
        posfile = "daniel-radiology.txt"
        negfile = "medline06-500k.txt"
    if dataset == "random10k-vs-500k":
        posfile = "random10k-06.txt"
        negfile = "medline06-500k.txt"
    # Other experiments
    if dataset == "mscanner-vs-500k":
        posfile = "mscanner-bibliography.txt"
        negfile = "medline06-500k.txt"
    if dataset == "pg06-vs-med06":
        posfile = "pharmgkb-Oct06.txt"
        negfile = articlelist
    if dataset == "gdsmall-vs-med06":
        posfile = "genedrug-small.txt"
        negfile = articlelist
    if dataset == "aids1k-vs-500k":
        posfile = "aids-bioethics-Oct06-1k.txt"
        negfile = "medline06-500k.txt"
    if dataset == "pg04-vs-go4":
        posfile = "pharmgkb-2004.txt"
        negfile = "geneontology-2004.txt"
    if dataset == "pg04-vs-500k":
        posfile = "pharmgkb-2004.txt"
        negfile = "medline06-500k.txt"
    if dataset == "pgdan-vs-500k":
        posfile = corpora / "pharmgkb-daniel.txt"
        negfile = "medline06-500k.txt"
    if not isinstance(posfile, path):
        posfile = corpora / posfile
    if not isinstance(negfile, path):
        negfile = corpora / negfile
