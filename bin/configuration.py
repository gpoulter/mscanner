"""Configuration for MedScanner

@author: Graham Poulter
                                   

Import this module to set up library paths and configure locations to
files used by the scanner, as well as configuration options.

These are the most useful options for users:

* base.working
* query.{limit, pseudocount, posfile, outputdb}
* validation.{recall, nfolds, pseudocount, posfile, negfile}

"""

import logging
import sys
from new import module
from path import path

__all__ = [ "base", "medline", "genedrug", "update", "query", "validation" ]

mtree = False
#mtree = True

#### Basic configuration used by other modules

b = base = module("config_base")
## Path to source directory
b.src = path(sys.argv[0]).dirname().abspath().parent
## Path to top 
b.top = b.src.parent
## Path to bin
b.bin = b.src / "bin"
## Path to lib
b.lib = b.src / "lib"
## Path to templates
b.templates = b.lib / "templates"
## Path to stylesheet
b.stylesheet = b.templates / "style.css"
## Path to base for working data
b.working = b.top / "testing"
if mtree: b.working = b.top / "data"
## Path to input files
b.input = b.working / "input"
## Path to output files
b.output = b.working / "output"
## Path to cache directory
b.cache = b.working / "cache"
## Path to web output directory
b.weboutput = b.src / "www" / "htdocs" / "output"
if mtree: b.weboutput = path("/export/apps/medscan/htdocs/output")

#### MEDLINE DATABASE CONFIGURATION

m = medline = module("config_medline")
## Path to BSD DB environment home directory
m.db_home = b.cache / "db_home"
## Path to DB of article objects
m.articledb = b.cache / "articles.db"
## Path to DB of term features for each article
m.featuredb = b.cache / "features.db"
## Path to to find MeSH term mapping database
m.meshdb = b.cache / "meshdb.txt"
## Path to term counts pickle
m.termcounts = b.cache / "termcounts.pickle"
## Path to list files already processed
m.processed = b.cache / "processed.txt"

#### GENEDRUG CONFIGURATION

gd = genedrug = module("config_genedrug")
## Path to GAPScore results in
gd.gapscore = b.cache / "gapscore.db"
## Path to gene-drug co-occurrence cache
gd.genedrug = b.cache / "genedrug.db"
## Path to pickled drug table (generated by drugtable.py)
gd.drugtable = b.input / "drugtable.pickle"

#### UPDATE CONFIGURATION (for update.py)

u = update = module("config_update")
## Path to compressed MEDLINE 
u.medline = b.working / "medline"
## Number of files to process between saving
u.save_delay = 10
## Pickle with MeSH terms to exlude (generated by meshexcludes.py)
u.mesh_excludes = b.input / "meshexcludes.pickle"
## Pickle with MeSH synonyms (generated by meshexcludes.py)
u.mesh_synonyms = b.input / "meshsynonyms.pickle"

#### QUERY CONFIGURATION (for query.py)

q = query = module("config_query")
## Path to file of positive training PMIDs (processed by fixcorpora.py)
q.posfile = b.input / "newpositives.txt"
## Integer for number of results, or float minimum score threshold
q.limit = 10000
## Per-term pseudocount to use
q.pseudocount = 0.01
## Prefix for result report files
q.prefix = b.output / "results/"
## Path to database output
q.outputdb = None
## Stylesheet for report
q.stylesheet = b.stylesheet

#### VALIDATOR CONFIGURATION (for validate.py)

v = validation = module("config_validation")
## File with all PubMed IDs (used for CGI script)
v.allpmids = b.input / "allpmids.txt"

## Positive training set (processed by fixcorpora.py)
#v.posfile = b.input / "newpositives.txt"
v.posfile = b.input / "oldpositives.txt"

## Negative training / testing set (processed by fixcorpora.py)
v.negfile = b.input / "oldnegatives.txt"
#v.negfile = b.input / "500kpmids.txt"
#v.negfile = v.allpmids

## Recall to achieve on training set
v.recall = 0.9
## Validation folds to use
v.nfolds = 5
## Pseudocounts to use
v.pseudocount = 0.01
## Whether to do a gene-drug co-occurrence filter
v.genedrug = False
## Whether to use Daniel's 10^-8 pseudocounts
v.daniel = False
## Prefix to use for report file
v.prefix = b.output / "valid/"
## Stylesheet for report
v.stylesheet = b.stylesheet

#### Logging configuration

logging.basicConfig(
    level    = logging.DEBUG,
    datefmt  = "%H:%M:%S",
    format   = "%(asctime)-9s %(levelname)-8s %(message)s",
)

#### Configure Python search path

sys.path.insert( 0, base.lib )
